# 微服务设计

[TOC]

我的第四篇读书笔记

![microservice design](microservice design.jpg)

## 第4章 集成

**集成**是微服务相关技术中最重要的。做得好，微服务可以保持自治，独立修改和发布；做不好会带来灾难。

###寻找理想的集成技术

- ==避免破坏性修改==
  - 有时候服务的修改会导致消费方也发生变化
    1. 应尽量避免发生这种情况
    2. 一个服务添加了一个字段，已有的消费方不应该受到影响
- 保证API技术无关性
  - 做到这一点，换技术栈的成本会更低
  - 不要选择对服务具体实现技术有限制的集成方式
- 使服务易用
  - 客户端库易用，但是会增加耦合
- 隐藏内部实现细节
  - 实现细节对消费方透明，否则会增加耦合，增加修改成本，增加技术债
  - 所有倾向于暴露内部实现细节的技术栈都不应该采用

###为用户创建接口

###不要共享数据库，否则

- 外部就能够知道实现细节，并与细节绑定
- 不方便更换存储技术
- 服务之间可以共享数据，无法共享行为
- 违反高内聚低耦合原则

### 同步VS异步

- 同步
  - 请求应答模式
  - 实现简单
  - 阻塞等待响应
- 异步
  - 请求应答+回调模式事件模型
  - 实现复杂
  - 业务流程的每一步分散到整个系统
  - 事件模型耦合低

### 编排&协同

- 编排
  - 依赖中心驱动业务流程
  - 中心控制点承担了太多职责，很多逻辑的起点
  - 出现上帝服务
  - 重量级编排方案修改代价大
- 协同
  - 系统各部分仅知道自己的职责
  - 具体怎么做的细节由各部分自己决定 
  - 事件驱动
  - 需要处理事件的服务只需要订阅事件
  - 需要额外的监控流程，监控结果映射到业务流程
  - 比编排更复杂，耦合低，更灵活

### RPC

- 易用使用
- 有些问题一开始不明显，但是会逐渐暴露出来，这些问题的代价远大于一开始迅速启动的好处
  - 有些RPC依赖特定的平台
  - 核心思想是隐藏远程调用的复杂性，但是有些封装过厚引起性能问题
  - 有可能开发会不知道这是远程调用，而肆意使用
  - 网络不可靠
  - 脆弱性
    - 只要接口声明发生了变化，所有的客户端都要重新生成桩
- 注意的问题
  - 不要对RPC过度抽象，导致网络因素完全隐藏
  - 确保可以独立升级服务器，不必强迫客户端升级
  - 客户端不要隐藏这是网络访问
- RPC比数据库集成是一个巨大的进步

### RESTful

- 一种RPC替代方案
- 引入资源概念
  - 一个资源只有一个接口
  - 利用不同的动词完成不同的操作
- [对RESTful不同风格的比较](http://martinfowler.com/articles/richardsonMaturityModel.html)
- 本身没有限制应该采用什么协议，HTTP最常用也最简单

#### RESTful&HTTP

- http的动词
  - GET 幂等的获取资源
  - POST 创建新资源，非幂等
  - PUT 创建或更新资源，幂等

### HATEOPS（超媒体作为程序状态的引擎）

- 超媒体数据自解释
- 程序不需要知道资源的URI
- 为每个资源定义好资源名
  - 客户端只需要知道资源名
  - URI包含在通讯的数据里，可以通过资源名找到
  - 客户端 服务端遵守相同的原则
  - 缺点
    - 通讯次数太多，客户端不断请求资源，发现链接直到找到需要的资源
    - 需要一定投入
    - 回报时间长

### DRY、代码重用和耦合

- 跨服务共用代码会引入耦合，比重复代码有更大的风险。

### 客户端库

- 应保持客户端api越薄越好
- 所以最好直接使用REST api

### 版本管理

- 语 义化版本管理的每一个版本号都遵循这样的格式:MAJOR.MINOR.PATCH。其中 MAJOR 的改变 意味着其中包含向后不兼容的修改;MINOR 的改变意味着有新功能的增加，但应该是向后 兼容的;最后，PATCH 的改变代表对已有功能的缺陷修复。
- 迟早发现破坏性修改
- 不同版本的接口共存
  - 旧版接口参数转换成新版参数，再旧版接口实现访问新版完成功能
- 新老用户使用不同版本的服务

### 为前端服务

- api网关只为一类前端或客户端服务（Backend For Frontends BFF）
- api网关聚合各服务，不包含业务逻辑，只包含与实现某种特定用户体验相关的逻辑

### 与第三方软件集成

- 把集成和定制工作放在自己能控制的部分
- 深度定制比从头做更贵
- 如果软件的能力不完全适合，改变组织的工作方式比定制更合理

### 绞杀者模式

- 劫持旧系统调用，决定是把这些调用路由到遗留代码还是导向新代码
- 逐步把旧系统功能替换掉，最后移除绞杀层

---

申请微信公众号有很长时间了，一直没有想清楚究竟应该发一些什么。后来想应该分享一些自己的原创思想和IT从业感悟，花了很长时间我才接受一个事实：我没有能力分享什么原创思想。T_T

最近我想到平时没事会读各种书，不如就把读书笔记分享到公众号。

> 本人在此做以下承诺
>
> - 我不创造知识，我只是知识的搬运工。
> - 所有文章只在本订阅号发布，同时会同步到github（https://github.com/runfriends/notes.git）
> - 所有内容都是本人平时读书记录的笔记和自己的心得感想
> - 绝不转发、抄袭他人文章，如果我的文章侵犯了您的权益请告知，本人会立即删除，并公开道歉

帖上订阅号二维码：

![qrcode_for_weixin_subscription](https://github.com/runfriends/notes/blob/master/qrcode_for_weixin_subscription.jpg?raw=true)